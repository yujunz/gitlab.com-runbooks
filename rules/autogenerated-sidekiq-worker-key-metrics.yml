# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./rules-jsonnet/sidekiq-worker-key-metrics.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Sidekiq Queue Key Indicators
  interval: 1m
  rules:
  - record: gitlab_background_jobs:queue:apdex:ratio_5m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="10"}[5m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="+Inf"}[5m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_5m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="10"}[5m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="+Inf"}[5m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_5m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency="high",le="+Inf"}[5m])
      )
  - record: gitlab_background_jobs:execution:error:rate_5m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency="high"}[5m])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_5m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="60"}[5m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="+Inf"}[5m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_5m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="300"}[5m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="+Inf"}[5m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_5m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high",le="+Inf"}[5m])
      )
  - record: gitlab_background_jobs:execution:error:rate_5m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency!="high"}[5m])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_30m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="10"}[30m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="+Inf"}[30m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_30m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="10"}[30m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="+Inf"}[30m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_30m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency="high",le="+Inf"}[30m])
      )
  - record: gitlab_background_jobs:execution:error:rate_30m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency="high"}[30m])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_30m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="60"}[30m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="+Inf"}[30m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_30m
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="300"}[30m])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="+Inf"}[30m])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_30m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high",le="+Inf"}[30m])
      )
  - record: gitlab_background_jobs:execution:error:rate_30m
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency!="high"}[30m])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_1h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="10"}[1h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="+Inf"}[1h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_1h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="10"}[1h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="+Inf"}[1h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_1h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency="high",le="+Inf"}[1h])
      )
  - record: gitlab_background_jobs:execution:error:rate_1h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency="high"}[1h])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_1h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="60"}[1h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="+Inf"}[1h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_1h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="300"}[1h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="+Inf"}[1h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_1h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high",le="+Inf"}[1h])
      )
  - record: gitlab_background_jobs:execution:error:rate_1h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency!="high"}[1h])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_6h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="10"}[6h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency="high", le="+Inf"}[6h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_6h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="10"}[6h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency="high", le="+Inf"}[6h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_6h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency="high",le="+Inf"}[6h])
      )
  - record: gitlab_background_jobs:execution:error:rate_6h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency="high"}[6h])
      )
  - record: gitlab_background_jobs:queue:apdex:ratio_6h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="60"}[6h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_queue_duration_seconds_bucket{urgency!="high", le="+Inf"}[6h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:apdex:ratio_6h
    expr: |
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="300"}[6h])
        )
      )
      /
      (
        sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
          rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high", le="+Inf"}[6h])
        ) > 0
      )
  - record: gitlab_background_jobs:execution:ops:rate_6h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_completion_seconds_bucket{urgency!="high",le="+Inf"}[6h])
      )
  - record: gitlab_background_jobs:execution:error:rate_6h
    expr: |
      sum by (environment, tier, type, stage, shard, priority, queue, feature_category, urgency) (
        rate(sidekiq_jobs_failed_total{urgency!="high"}[6h])
      )
  - record: gitlab_background_jobs:execution:error:ratio_5m
    expr: |
      gitlab_background_jobs:execution:error:rate_5m
      /
      gitlab_background_jobs:execution:ops:rate_5m
  - record: gitlab_background_jobs:execution:error:ratio_30m
    expr: |
      gitlab_background_jobs:execution:error:rate_30m
      /
      gitlab_background_jobs:execution:ops:rate_30m
  - record: gitlab_background_jobs:execution:error:ratio_1h
    expr: |
      gitlab_background_jobs:execution:error:rate_1h
      /
      gitlab_background_jobs:execution:ops:rate_1h
  - record: gitlab_background_jobs:execution:error:ratio_6h
    expr: |
      gitlab_background_jobs:execution:error:rate_6h
      /
      gitlab_background_jobs:execution:ops:rate_6h
  - alert: sidekiq_background_job_error_ratio_burn_rate_slo_out_of_bounds
    for: 2m
    annotations:
      title: The `{{ $labels.queue }}` queue, `{{ $labels.stage }}` stage, has an error rate outside of
        SLO
      description: |
        The `{{ $labels.queue }}` queue, `{{ $labels.stage }}` stage, has an error rate outside of SLO.

        Currently the metric value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-queue-detail/sidekiq-queue-detail
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '12'
      grafana_variables: environment,stage,queue
      promql_template_1: >-
        gitlab_background_jobs:execution:error:ratio_1h{environment="$environment", type="$type", stage="$stage",
        component="$component"}
      runbook: docs/sidekiq/service-sidekiq.md
    labels:
      alert_type: symptom
      experimental: 'yes'
      metric: gitlab_background_jobs:execution:error:ratio_1h
      period: 2m
      rules_domain: general
      severity: s4
      slo_alert: 'yes'
    expr: |
      (
        (
          gitlab_background_jobs:execution:error:ratio_1h > (14.4 * 0.01)
        and
          gitlab_background_jobs:execution:error:ratio_5m > (14.4 * 0.01)
        )
        or
        (
          gitlab_background_jobs:execution:error:ratio_6h > (6 * 0.01)
        and
          gitlab_background_jobs:execution:error:ratio_30m > (6 * 0.01)
        )
      )
      and
      (
        gitlab_background_jobs:execution:ops:rate_6h > 0.06667
      )
  - alert: sidekiq_background_job_execution_apdex_ratio_burn_rate_slo_out_of_bounds
    for: 2m
    annotations:
      title: The `{{ $labels.queue }}` queue, `{{ $labels.stage }}` stage, has a execution latency outside
        of SLO
      description: |
        The `{{ $labels.queue }}` queue, `{{ $labels.stage }}` stage, has a execution latency outside of SLO.

        Currently the metric value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-queue-detail/sidekiq-queue-detail
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '10'
      grafana_variables: environment,stage,queue
      promql_template_1: >-
        gitlab_background_jobs:execution:apdex:ratio_1h{environment="$environment", type="$type", stage="$stage",
        component="$component"}
      runbook: docs/sidekiq/service-sidekiq.md
    labels:
      alert_type: symptom
      experimental: 'yes'
      metric: gitlab_background_jobs:execution:apdex:ratio_1h
      period: 2m
      rules_domain: general
      severity: s4
      slo_alert: 'yes'
    expr: |
      (
        (
          (1 - gitlab_background_jobs:execution:apdex:ratio_1h) > (14.4 * 0.01)
          and
          (1 - gitlab_background_jobs:execution:apdex:ratio_5m) > (14.4 * 0.01)
        )
        or
        (
          (1 - gitlab_background_jobs:execution:apdex:ratio_6h) > (6 * 0.01)
          and
          (1 - gitlab_background_jobs:execution:apdex:ratio_30m) > (6 * 0.01)
        )
      )
      and
      (
        gitlab_background_jobs:execution:ops:rate_6h > 0.06667
      )
  - alert: sidekiq_background_job_queue_apdex_ratio_burn_rate_slo_out_of_bounds
    for: 2m
    annotations:
      title: The `{{ $labels.queue }}` queue, `{{ $labels.stage }}` stage, has a queue latency outside
        of SLO
      description: |
        The `{{ $labels.queue }}` queue, `{{ $labels.stage }}` stage, has a queue latency outside of SLO.

        Currently the metric value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-queue-detail/sidekiq-queue-detail
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '9'
      grafana_variables: environment,stage,queue
      promql_template_1: >-
        gitlab_background_jobs:queue:apdex:ratio_1h{environment="$environment", type="$type", stage="$stage",
        component="$component"}
      runbook: docs/sidekiq/service-sidekiq.md
    labels:
      alert_type: symptom
      experimental: 'yes'
      metric: gitlab_background_jobs:queue:apdex:ratio_1h
      period: 2m
      rules_domain: general
      severity: s4
      slo_alert: 'yes'
    expr: |
      (
        (
          (1 - gitlab_background_jobs:queue:apdex:ratio_1h) > (14.4 * 0.01)
          and
          (1 - gitlab_background_jobs:queue:apdex:ratio_5m) > (14.4 * 0.01)
        )
        or
        (
          (1 - gitlab_background_jobs:queue:apdex:ratio_6h) > (6 * 0.01)
          and
          (1 - gitlab_background_jobs:queue:apdex:ratio_30m) > (6 * 0.01)
        )
      )
      and
      (
        gitlab_background_jobs:execution:ops:rate_6h > 0.06667
      )
  - alert: sidekiq_throttled_jobs_enqueued_without_dequeuing
    for: 2m
    annotations:
      title: Sidekiq jobs are being enqueued without being dequeued
      description: |
        The `{{ $labels.queue }}` queue appears to have jobs being enqueued without
        those jobs being executed.

        This could be the result of a Sidekiq server configuration issue, where
        no Sidekiq servers are configured to dequeue the specific queue.
      grafana_dashboard_id: sidekiq-queue-detail/sidekiq-queue-detail
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '15'
      grafana_variables: environment,stage,queue
      promql_template_1: >-
        sidekiq_enqueued_jobs_total{environment="$environment", type="$type", stage="$stage", component="$component"}
      runbook: docs/sidekiq/service-sidekiq.md
    labels:
      alert_type: cause
      metric: sidekiq_enqueued_jobs_total
      period: 2m
      rules_domain: general
      severity: s4
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (
        sum by (environment, queue, feature_category) (rate(sidekiq_enqueued_jobs_total{urgency="throttled"}[10m] offset 10m)) > 0
      )
      unless
      (
        sum by (environment, queue, feature_category) (rate(sidekiq_jobs_completion_seconds_count{urgency="throttled"}[20m])) > 0
        or
        sum by (environment, queue, feature_category) (rate(sidekiq_jobs_failed_total{urgency="throttled"}[20m])) > 0
        or
        sum by (environment, queue, feature_category) (rate(sidekiq_jobs_retried_total{urgency="throttled"}[20m])) > 0
        or
        sum by (environment, queue, feature_category) (avg_over_time(sidekiq_running_jobs{urgency="throttled"}[20m])) > 0
      )
