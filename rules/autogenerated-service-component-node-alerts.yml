# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./rules-jsonnet/service-component-node-alerts.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Service Component/Node Alerts
  interval: 1m
  rules:
  - alert: ServiceSLOApdexViolationSingleNode
    for: 10m
    annotations:
      title: Node `{{ $labels.fqdn }}`, `{{ $labels.component }}` component is violating its apdex SLO
      description: |
        `{{ $labels.fqdn }}` has been violating its apdex SLO for more than 10m.

        Since the {{ $labels.type }} service is not redundant, failures in the `{{ $labels.component }}` component could lead to user-impacting service degradation.

        Currently the apdex value is {{ $value | humanizePercentage }}.

        Recommended course of action: review ELK logs, check for possible user action or unusual activity.
      grafana_dashboard_id: >-
        alerts-component_node_multiburn_apdex/alerts-component-node-multi-window-multi-burn-rate-apdex-out-of-slo
      grafana_dashboard_link: >-
        https://dashboards.gitlab.net/d/alerts-component_node_multiburn_apdex/alerts-component-node-multi-window-multi-burn-rate-apdex-out-of-slo?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage }}&var-component={{
        $labels.component }}&var-fqdn={{ $labels.fqdn }}
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '64104'
      grafana_variables: environment,type,stage,component,fqdn
      promql_template_1: >-
        gitlab_component_node_apdex:ratio_1h{environment="$environment", type="$type", stage="$stage",
        component="$component", fqdn="$fqdn"}
      runbook: docs/{{ $labels.type }}/service-{{ $labels.type }}.md
    labels:
      alert_type: symptom
      rules_domain: general
      severity: s4
      slo_alert: 'yes'
    expr: |
      (
        (
          (
            gitlab_component_node_apdex:ratio_1h
            < on(tier, type) group_left()
            (1 - (14.4 * (1 - slo:min:events:gitlab_component_node_apdex:ratio)))
          )
          and
          (
            gitlab_component_node_apdex:ratio_5m
            < on(tier, type) group_left()
            (1 - (14.4 * (1 - slo:min:events:gitlab_component_node_apdex:ratio)))
          )
        )
        or
        (
          (
            gitlab_component_node_apdex:ratio_6h
            < on(tier, type) group_left()
            (1 - (6 * (1 - slo:min:events:gitlab_component_node_apdex:ratio)))
          )
          and
          (
            gitlab_component_node_apdex:ratio_30m
            < on(tier, type) group_left()
            (1 - (6 * (1 - slo:min:events:gitlab_component_node_apdex:ratio)))
          )
        )
      )
      and
      (
        gitlab_component_node_ops:rate_1h >= 1
      )
  - alert: ServiceSLOErrorViolationSingleNode
    for: 10m
    annotations:
      title: Node `{{ $labels.fqdn }}`, `{{ $labels.component }}` component is violating its error SLO
      description: |
        `{{ $labels.fqdn }}` has been violating its error SLO for more than 10m.

        Since the {{ $labels.type }} service is not redundant, failures in the `{{ $labels.component }}` component could lead to user-impacting service degradation.

        Currently the error rate value is {{ $value | humanizePercentage }}.

        Recommended course of action: review ELK logs, check for possible user action or unusual activity.
      grafana_dashboard_id: >-
        alerts-component_node_multiburn_error/alerts-component-node-multi-window-multi-burn-rate-error-rate-out-of-slo
      grafana_dashboard_link: >-
        https://dashboards.gitlab.net/d/alerts-component_node_multiburn_error/alerts-component-node-multi-window-multi-burn-rate-error-rate-out-of-slo?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage }}&var-component={{
        $labels.component }}&var-fqdn={{ $labels.fqdn }}
      grafana_min_zoom_hours: '6'
      grafana_panel_id: '64104'
      grafana_variables: environment,type,stage,component,fqdn
      promql_template_1: >-
        gitlab_component_node_errors:ratio_5m{environment="$environment", type="$type", stage="$stage",
        component="$component", fqdn="$fqdn"}
      runbook: docs/{{ $labels.type }}/service-{{ $labels.type }}.md
    labels:
      alert_type: symptom
      rules_domain: general
      severity: s4
      slo_alert: 'yes'
    expr: |
      (
        (
          gitlab_component_node_errors:ratio_1h
          > on(tier, type) group_left()
          (
            14.4 * (
              avg(slo:max:events:gitlab_component_node_errors:ratio) by (tier, type)
            )
          )
        and
          gitlab_component_node_errors:ratio_5m
          > on(tier, type) group_left()
          (
            14.4 * (
              avg(slo:max:events:gitlab_component_node_errors:ratio) by (tier, type)
            )
          )
        )
        or
        (
          gitlab_component_node_errors:ratio_6h
          > on(tier, type) group_left()
          (
            6 * (
              avg(slo:max:events:gitlab_component_node_errors:ratio) by (tier, type)
            )
          )
        and
          gitlab_component_node_errors:ratio_30m
          > on(tier, type) group_left()
          (
            6 * (
              avg(slo:max:events:gitlab_component_node_errors:ratio) by (tier, type)
            )
          )
        )
      )
      and
      (
        gitlab_component_node_ops:rate_1h >= 1
      )
